<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - Licencias CPEM 25</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .sidebar-link.active {
      background-color: #3b82f6;
      color: white;
    }
  </style>
</head>

<body class="bg-gray-100">
  <div class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col">
      <div class="p-6 border-b border-gray-700">
        <h1 class="text-xl font-bold">游늵 Admin Dashboard</h1>
        <p class="text-xs text-gray-400 mt-1">CPEM N춿 25</p>
      </div>

      <nav class="flex-1 p-4 space-y-2">
        <a href="#" onclick="cambiarVista('solicitudes'); return false;" id="menu-solicitudes"
          class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-700">
          <span>游늶</span>
          <span>Solicitudes</span>
        </a>

        <a href="#" onclick="cambiarVista('justificaciones'); return false;" id="menu-justificaciones"
          class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-700">
          <span>游늬</span>
          <span>Justificaciones</span>
        </a>
      </nav>

      <div class="p-4 border-t border-gray-700">
        <p class="text-xs text-gray-400">Administrador:</p>
        <p class="text-sm font-semibold" id="admin-email">Cargando...</p>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">

      <!-- Header -->
      <header class="bg-white shadow-sm p-6 border-b">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-bold text-gray-800" id="titulo-seccion">Solicitudes de Licencia</h2>
            <p class="text-sm text-gray-600 mt-1" id="subtitulo-seccion">Gestione las solicitudes pendientes</p>
          </div>
          <button onclick="recargarDatos()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
            <span>游댃</span>
            <span>Recargar</span>
          </button>
        </div>
      </header>

      <!-- Loading -->
      <div id="loading" class="flex items-center justify-center p-12">
        <div class="text-center">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-gray-600">Cargando datos...</p>
        </div>
      </div>

      <!-- Vista Solicitudes -->
      <div id="vista-solicitudes" class="p-6 hidden">
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docente
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo
                    Licencia</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fechas</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curso/Cargo
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones
                  </th>
                </tr>
              </thead>
              <tbody id="tabla-solicitudes" class="bg-white divide-y divide-gray-200">
                <!-- Se llenar치 din치micamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Vista Justificaciones -->
      <div id="vista-justificaciones" class="p-6 hidden">
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docente
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNI</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IDs
                    Solicitudes</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Archivo
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones
                  </th>
                </tr>
              </thead>
              <tbody id="tabla-justificaciones" class="bg-white divide-y divide-gray-200">
                <!-- Se llenar치 din치micamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Modal para editar estado -->
  <div id="modal-estado" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 class="text-xl font-bold mb-4">Cambiar Estado</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nuevo Estado</label>
          <select id="nuevo-estado" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="Pendiente">Pendiente</option>
            <option value="Autorizado">Autorizado</option>
            <option value="Justificado">Justificado</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button onclick="cerrarModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancelar
          </button>
          <button onclick="guardarCambioEstado()"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para enviar email -->
  <div id="modal-email" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg">
      <h3 class="text-xl font-bold mb-4">Enviar Email al Docente</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="email-docente" readonly
            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje Personalizado</label>
          <textarea id="mensaje-email" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"
            placeholder="Escriba su mensaje aqu칤..."></textarea>
        </div>
        <div class="flex gap-3">
          <button onclick="cerrarModalEmail()"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancelar
          </button>
          <button onclick="enviarEmailDocente()"
            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            Enviar Email
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let solicitudesData = [];
    let justificacionesData = [];
    let registroEditando = null;
    let emailData = null;

    // Cargar email del admin
    google.script.run
      .withSuccessHandler(function (email) {
        document.getElementById('admin-email').textContent = email;
      })
      .obtenerEmailUsuario();

    // Cambiar entre vistas
    function cambiarVista(vista) {
      document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
      document.getElementById('vista-solicitudes').classList.add('hidden');
      document.getElementById('vista-justificaciones').classList.add('hidden');

      if (vista === 'solicitudes') {
        document.getElementById('menu-solicitudes').classList.add('active');
        document.getElementById('titulo-seccion').textContent = 'Solicitudes de Licencia';
        document.getElementById('subtitulo-seccion').textContent = 'Gestione las solicitudes pendientes';
        document.getElementById('vista-solicitudes').classList.remove('hidden');
        cargarSolicitudes();
      } else if (vista === 'justificaciones') {
        document.getElementById('menu-justificaciones').classList.add('active');
        document.getElementById('titulo-seccion').textContent = 'Justificaciones Cargadas';
        document.getElementById('subtitulo-seccion').textContent = 'Revise los archivos justificatorios';
        document.getElementById('vista-justificaciones').classList.remove('hidden');
        cargarJustificaciones();
      }
    }

    // Recargar datos
    function recargarDatos() {
      const vistaActual = document.getElementById('vista-solicitudes').classList.contains('hidden') ? 'justificaciones' : 'solicitudes';
      cambiarVista(vistaActual);
    }

    // Cargar solicitudes
    function cargarSolicitudes() {
      document.getElementById('loading').classList.remove('hidden');
      console.log('[DEBUG] Iniciando cargarSolicitudes...');
      
      google.script.run
        .withSuccessHandler(function (data) {
          document.getElementById('loading').classList.add('hidden');
          console.log('[DEBUG] Solicitudes recibidas del servidor:', data);
          console.log('[DEBUG] Tipo de dato recibido:', typeof data);
          console.log('[DEBUG] 쮼s array?:', Array.isArray(data));
          
          if (data) {
            console.log('[DEBUG] Cantidad de solicitudes:', data.length);
            if (data.length > 0) {
              console.log('[DEBUG] Primera solicitud:', JSON.stringify(data[0]));
            }
          }

          // Validar que data no sea null y sea un array
          if (!data || !Array.isArray(data)) {
            console.error('[ERROR] Datos inv치lidos recibidos:', data);
            solicitudesData = [];
            renderizarSolicitudes([]);
            return;
          }

          solicitudesData = data;
          renderizarSolicitudes(data);
        })
        .withFailureHandler(function (error) {
          document.getElementById('loading').classList.add('hidden');
          console.error('[ERROR] Error al cargar solicitudes:', error);
          console.error('[ERROR] Error message:', error.message);
          alert('Error al cargar solicitudes: ' + error.message);
        })
        .obtenerTodasSolicitudes();
    }

    // Renderizar solicitudes
    function renderizarSolicitudes(solicitudes) {
      const tbody = document.getElementById('tabla-solicitudes');
      tbody.innerHTML = '';

      // Validar que solicitudes sea un array
      if (!solicitudes || !Array.isArray(solicitudes)) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay datos para mostrar</td></tr>';
        return;
      }

      if (solicitudes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay solicitudes registradas</td></tr>';
        return;
      }

      solicitudes.forEach(sol => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        const estadoColor = sol.estado === 'Pendiente' ? 'bg-yellow-100 text-yellow-800' :
          sol.estado === 'Autorizado' ? 'bg-green-100 text-green-800' :
            'bg-blue-100 text-blue-800';

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatearFecha(sol.timestamp)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sol.nombres} ${sol.apellidos}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sol.dni}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${sol.tipoLicencia}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatearFechaCorta(sol.fechaDesde)} - ${formatearFechaCorta(sol.fechaHasta)}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${sol.cursoOCargo || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${estadoColor}">${sol.estado}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="abrirModalEstado(${sol.rowIndex}, 'solicitud')" 
                    class="text-blue-600 hover:text-blue-800 mr-3">九勇 Editar</button>
            <button onclick="abrirModalEmail('${sol.email}', '${sol.nombres} ${sol.apellidos}')" 
                    class="text-green-600 hover:text-green-800">游닎 Email</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Cargar justificaciones
    function cargarJustificaciones() {
      document.getElementById('loading').classList.remove('hidden');
      google.script.run
        .withSuccessHandler(function (data) {
          document.getElementById('loading').classList.add('hidden');
          console.log('Justificaciones recibidas:', data);

          // Validar que data no sea null y sea un array
          if (!data || !Array.isArray(data)) {
            console.error('Datos inv치lidos recibidos:', data);
            justificacionesData = [];
            renderizarJustificaciones([]);
            return;
          }

          justificacionesData = data;
          renderizarJustificaciones(data);
        })
        .withFailureHandler(function (error) {
          document.getElementById('loading').classList.add('hidden');
          console.error('Error al cargar:', error);
          alert('Error al cargar justificaciones: ' + error.message);
        })
        .obtenerTodasJustificaciones();
    }

    // Renderizar justificaciones
    function renderizarJustificaciones(justificaciones) {
      const tbody = document.getElementById('tabla-justificaciones');
      tbody.innerHTML = '';

      // Validar que justificaciones sea un array
      if (!justificaciones || !Array.isArray(justificaciones)) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay datos para mostrar</td></tr>';
        return;
      }

      if (justificaciones.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay justificaciones registradas</td></tr>';
        return;
      }

      justificaciones.forEach(just => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatearFecha(just.timestamp)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${just.nombres} ${just.apellidos}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${just.dni}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${just.idsSolicitudes}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${just.cantidadLicencias}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            ${just.archivoUrl ? `<a href="${just.archivoUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">游늹 Ver Archivo</a>` : '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="abrirModalEmail('${just.email}', '${just.nombres} ${just.apellidos}')" 
                    class="text-green-600 hover:text-green-800">游닎 Email</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Abrir modal de estado
    function abrirModalEstado(rowIndex, tipo) {
      registroEditando = { rowIndex, tipo };
      document.getElementById('modal-estado').classList.remove('hidden');
    }

    // Cerrar modal de estado
    function cerrarModal() {
      document.getElementById('modal-estado').classList.add('hidden');
      registroEditando = null;
    }

    // Guardar cambio de estado
    function guardarCambioEstado() {
      const nuevoEstado = document.getElementById('nuevo-estado').value;

      if (!registroEditando) return;

      document.getElementById('loading').classList.remove('hidden');
      google.script.run
        .withSuccessHandler(function (result) {
          document.getElementById('loading').classList.add('hidden');
          if (result.success) {
            alert('Estado actualizado correctamente');
            cerrarModal();
            recargarDatos();
          } else {
            alert('Error: ' + result.error);
          }
        })
        .withFailureHandler(function (error) {
          document.getElementById('loading').classList.add('hidden');
          alert('Error al actualizar: ' + error.message);
        })
        .actualizarEstadoFila(registroEditando.rowIndex, nuevoEstado);
    }

    // Abrir modal de email
    function abrirModalEmail(email, nombre) {
      emailData = { email, nombre };
      document.getElementById('email-docente').value = email;
      document.getElementById('mensaje-email').value = '';
      document.getElementById('modal-email').classList.remove('hidden');
    }

    // Cerrar modal de email
    function cerrarModalEmail() {
      document.getElementById('modal-email').classList.add('hidden');
      emailData = null;
    }

    // Enviar email al docente
    function enviarEmailDocente() {
      const mensaje = document.getElementById('mensaje-email').value.trim();

      if (!mensaje) {
        alert('Por favor ingrese un mensaje');
        return;
      }

      if (!emailData) return;

      document.getElementById('loading').classList.remove('hidden');
      google.script.run
        .withSuccessHandler(function (result) {
          document.getElementById('loading').classList.add('hidden');
          if (result.success) {
            alert('Email enviado correctamente (borrador creado)');
            cerrarModalEmail();
          } else {
            alert('Error: ' + result.error);
          }
        })
        .withFailureHandler(function (error) {
          document.getElementById('loading').classList.add('hidden');
          alert('Error al enviar: ' + error.message);
        })
        .enviarEmailAdmin(emailData.email, emailData.nombre, mensaje);
    }

    // Formatear fecha completa
    function formatearFecha(fecha) {
      if (!fecha) return '-';
      const d = new Date(fecha);
      return d.toLocaleDateString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Formatear fecha corta
    function formatearFechaCorta(fecha) {
      if (!fecha) return '-';
      const d = new Date(fecha);
      return d.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Iniciar cargando solicitudes
    cambiarVista('solicitudes');
  </script>

</body>

</html>